#!/usr/bin/env ruby

require "bundler/setup"

$:.push File.expand_path("../../lib", __FILE__)

require 'optimist'
args = Optimist.options do
  opt :metrics_port, "Port to expose the metrics endpoint on, 0 to disable metrics", :type => :integer, :default => (ENV['METRICS_PORT'] || 9394).to_i
  opt :thanos_host, "Host of the Thanos metrics server", :type => :string, :default => ENV['THANOS_HOST']
  opt :thanos_port, "Port of the Thanos metrics server", :type => :integer, :default => ENV['THANOS_PORT'].to_i
  opt :persister_promql_namespace, "Kubernetes namespace for persister's PromQL", :type => :integer, :default => ENV['PERSISTER_PROMQL_NAMESPACE']
end

require "topological_inventory/orchestrator/application_metrics"
require "topological_inventory/orchestrator/metric_scaler"

metrics = TopologicalInventory::Orchestrator::ApplicationMetrics.new(args[:metrics_port])

Signal.trap("TERM") do
  metrics.stop_server
  exit
end

w = TopologicalInventory::Orchestrator::MetricScaler.new("#{args[:thanos_host]}:#{args[:thanos_port]}", args[:persister_promql_namespace])
w.run
